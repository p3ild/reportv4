<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Thông báo</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<script>
	$(document).ready(function () {
		extendWidth();
		main();
	});
	const BUTTON_ID = "parent-button"

	let countdownSecond = 5;
	let offsetRedirect = 0;
	let currentSecond = 0;
	async function main() {

		//Get instance host
		const { host, urlApp, urlReport } = await getCoreURL();

		let listButton = createButtonOnGlobalDocument({ urlReport, urlApp });
		let { overrideBackBtn, redirectToReportAppBtn } = listButton

		document.getElementsByClassName("list-report-app")[0].getElementsByTagName("a")[0].onclick = () => {
			overrideBackBtn.click();
		};
		document.getElementsByClassName("target-report-app")[0].getElementsByTagName("a")[0].onclick = () => {
			redirectToReportAppBtn.click();
		}

		let interval = setInterval(function () {
			if (currentSecond >= (countdownSecond + offsetRedirect)) {
				clearInterval(interval);
				redirectToReportAppBtn.click();

			}

			currentSecond++;
			renderSecondUI({});
			//Update second on UI
		}, 1000);

	}

	async function getCoreURL() {
		let hrefAsArray = window.parent.location.href.split('/');
		let reportUID = hrefAsArray.pop();
		let host = hrefAsArray.slice(0, hrefAsArray.findIndex(e => e == "dhis-web-reports")).join('/')


		let allApps = await fetch(`${host}/api/apps`).then(e => e.json()).then(e => (e));
		let reportApp = allApps.find(e => e.folderName.includes('reportv4'));

		const urlApp = `${reportApp?.launchUrl}#/home`
		const urlReport = `${reportApp?.launchUrl}#/report?id=${reportUID}`
		return { host, urlApp, urlReport }
	}

	function createButtonOnGlobalDocument({ urlReport, urlApp }) {
		let listNewButton = {}
		let originBack = document.evaluate('//*[@id="dhis2-app-root"]/div/div/div/div/div/div/main/div/div[1]/a', window.parent.document, null, XPathResult.ANY_TYPE, null)?.iterateNext();
		let overrideBackBtn = originBack.cloneNode();
		overrideBackBtn.setAttribute('id', 'clone-back')
		overrideBackBtn?.setAttribute('href', urlApp)
		overrideBackBtn.text = originBack.text
		listNewButton = {
			...listNewButton,
			overrideBackBtn
		};


		let redirectToReportAppBtn = originBack.cloneNode();
		redirectToReportAppBtn.setAttribute("id", BUTTON_ID);
		redirectToReportAppBtn?.setAttribute('href', urlReport)
		redirectToReportAppBtn?.setAttribute("style", "margin: 10px;");// display: none;
		redirectToReportAppBtn.text = "Sử dụng báo cáo trong ứng dụng mới"
		listNewButton = {
			...listNewButton,
			redirectToReportAppBtn
		};
		Object.values(listNewButton).forEach(e => originBack.after(e));
		originBack.remove();

		return listNewButton
	}

	function renderSecondUI({ }) {
		let textCount = '';
		if (currentSecond == 0 || // init
			currentSecond < countdownSecond
		) {
			textCount = `Tự động chuyển sang báo cáo mới sau ${countdownSecond - currentSecond} giây ...`;
		}

		if (currentSecond >= countdownSecond) {
			textCount = `Đang chuyển sang ứng dụng mới ...`;
			window.parent.location.href = urlReport
		}

		document.getElementsByClassName("count-second")[0].textContent = textCount;
	}

	function extendWidth() {
		var parentIframe = window.parent.document.evaluate('/html/body/div[1]/div/div/div/div/div/div/main/div', window.parent.document, null, XPathResult.ANY_TYPE, null)
		var domObj = parentIframe.iterateNext()
		domObj.style.width = "100%"
	}

</script>

<style>
	html {

		margin: 0;
		padding: 0;
	}

	body {
		background: linear-gradient(135deg, #4a90a4 0%, #2980b9 50%, #3498db 100%);
		margin: auto;
	}

	.container {
		margin: auto;
		width: 80%;
		text-align: center;
		position: relative;
		height: 100vh;
		border-radius: 4px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.main-box {
		width: 35%;
		min-width: 400px;
		height: 66vh;
		text-align: center;
		z-index: 0;
		position: relative;
		background: rgba(255, 255, 255, 0.9);
		backdrop-filter: blur(15px);
		padding: 2rem;
		box-shadow: 0 10px 40px rgba(74, 144, 164, 0.3);
		border-radius: 12px;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
	}


	h1 {
		font-family: 'Lato', sans-serif;
		font-weight: 900;
		font-size: 2rem;
		text-align: center;
		margin: 0;
		color: #2d3748;
		letter-spacing: .10rem;
		padding-bottom: .5rem;
	}

	h2 {
		font-family: 'Lato', sans-serif;
		font-weight: 400;
		font-size: 1.1rem;
		text-align: center;
		margin: 0;
		color: #2d3748;
		letter-spacing: .10rem;
		padding-bottom: 0.5rem;
	}

	h3 {
		font-family: 'Lato', sans-serif;
		font-weight: 900;
		font-size: 1rem;
		text-align: center;
		margin: 0;
		color: white;
		letter-spacing: .10rem;
		width: 100%;
	}

	.button {
		margin-top: 1.5rem !important;
		width: 14rem;
		border: 3px solid #2980b9;
		margin: auto;
		text-align: center;
		padding: 0.8rem;
		color: white;
		border-radius: 8px;
		background-color: #2980b9;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	#home:hover {
		background-color: #3498db;
		color: white;
		border: 3px solid #3498db;
		transform: translateY(-2px);
		box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.4);
		transition: all 0.3s ease;
	}

	#home {
		transition: all 0.3s ease;
	}

	.header-section {
		text-align: center;
	}

	.icon-section {
		margin-bottom: 1rem;
	}

	.notification-icon {
		font-size: 2.5rem;
		margin-bottom: 0.5rem;
		color: #e74c3c;
	}

	.content-section {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: space-around;
		padding: 1rem 0;
	}

	.info-box {
		background: rgba(52, 152, 219, 0.1);
		border-left: 4px solid #3498db;
		padding: 1rem;
		margin: 1rem 0;
		border-radius: 6px;
	}

	.info-box p {
		margin: 0.5rem 0;
		color: #2d3748;
		font-size: 1rem;
		text-align: left;
		display: flex;
		align-items: center;
	}

	.info-box p i {
		margin-right: 0.5rem;
		color: #2980b9;
		width: 20px;
	}

	.countdown-section {
		padding: 0.8rem;
		background: rgba(52, 152, 219, 0.15);
		border-radius: 8px;
		font-weight: 600;
		color: #2c3e50;
		font-size: 1rem;
	}

	.action-section {
		margin-top: auto;
		padding-top: 1rem;
	}

	.button a {
		display: flex;
		align-items: center;
		justify-content: space-between;
		width: 100%;
		text-decoration: none;
		color: inherit;
	}

	.button a span {
		flex: 1;
		text-align: center;
	}

	.button a i {
		margin-left: 0.5rem;
		font-size: 1rem;
	}


	svg {
		display: none;
	}
</style>

<body>
	<!-- partial:index.partial.html -->
	<div class="container">
		<div class="main-box">
			<div class="header-section">
				<div class="icon-section">
					<div class="notification-icon">
						<i class="fas fa-exclamation-triangle"></i>
					</div>
				</div>
				<h1>Thông báo</h1>
			</div>

			<div class="content-section">
				<h2 class="list-report-app">Báo cáo này đã được chuyển sang sử dụng trong ứng dụng <a
						class='button-direct' href="./">Báo cáo chuẩn</a> mới.</h2>
				
				<div class="info-box">
					<p><i class="fas fa-magic"></i> Giao diện được cải tiến hoàn toàn</p>
					<p><i class="fas fa-rocket"></i> Hiệu suất xử lý nhanh hơn</p>
					<p><i class="fas fa-chart-bar"></i> Tính năng báo cáo phong phú hơn</p>
				</div>

				<div class="countdown-section">
					<span class="count-second"></span>
				</div>
			</div>
			
			<div class="action-section">
				<div id="home" class="button">
					<h3 class="target-report-app">
						<a class='button-direct'>
							<span>Mở báo cáo trong ứng dụng mới</span>
							<i class="fa fa-arrow-right"></i>
						</a>
					</h3>
				</div>
			</div>
		</div>

	</div>
	<!-- partial -->

</body>

</html>