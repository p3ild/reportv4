<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2 Report - Financial Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .load-controls {
            margin: 10px 0;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .load-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .load-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            color: #28a745;
            font-size: 14px;
            font-weight: bold;
        }
        
        .mainTable {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .mainTable td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        table td, table th {
            padding: 6px;
            border: 1px solid #333;
            text-align: center;
        }
        
        table th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .data-row {
            background-color: #fff;
        }
        
        .data-row:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .strong {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="downloadExcel">
            <!-- Load Data Button and Status -->
            <div class="load-controls">
                <button id="loadDataBtn" class="load-btn">
                    Load Data
                </button>
                <span id="loadStatus" class="status"></span>
            </div>
            
            <table id="tableHeader" class="mainTable" border="0" width="100%" cellspacing="0" cellpadding="0">
                <tbody>
                    <tr>
                        <td>
                            <p id="orgUnits" align="left">&nbsp;</p>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" colspan="19">
                            <strong style="font-size:16px">TÌNH HÌNH THU CHI NGÂN SÁCH Y TẾ</strong>
                        </td>
                    </tr>
                    <tr>
                        <td class="periods" align="center" colspan="19">&nbsp;</td>
                    </tr>
                    <tr>
                        <td>
                            <div align='left'>Biểu số 2</div>
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div id="formreport">
                <table id="mainTable1" width="100%" border="1" cellpadding="2" cellspacing="0">
                    <tbody>
                        <tr>
                            <td style="text-align: center" rowspan="3">TT</td>
                            <td style="text-align: center" rowspan="3">Tên cơ sở</td>
                            <td style="text-align: center" colspan="4">Phân loại tự chủ</td>
                            <td style="text-align: center" colspan="13">TỔNG NGUỒN THU</td>
                        </tr>
                        <tr>
                            <td style="text-align: center" rowspan="2">Nhóm 1</td>
                            <td style="text-align: center" rowspan="2">Nhóm 2</td>
                            <td style="text-align: center" rowspan="2">Nhóm 3</td>
                            <td style="text-align: center" rowspan="2">Nhóm 4</td>
                            <td style="text-align: center" rowspan="2">TỔNG SỐ</td>
                            <td style="text-align: center" colspan="4">Nguồn NSNN cấp chi thường xuyên</td>
                            <td style="text-align: center" rowspan="2">NSNN cấp chi đầu tư và XDCB</td>
                            <td style="text-align: center" rowspan="2">Kinh phí viện trợ</td>
                            <td style="text-align: center" colspan="6">Nguồn thu</td>
                        </tr>
                        <tr>
                            <td style="text-align: center">Tổng số</td>
                            <td style="text-align: center">NSNN cấp chi thường xuyên</td>
                            <td style="text-align: center">NSNN cấp chi không thường xuyên (không có CTMT)</td>
                            <td style="text-align: center">NSNN cấp chi CTMT</td>
                            <td style="text-align: center">Tổng số</td>
                            <td style="text-align: center">Thu BHYT</td>
                            <td style="text-align: center">Thu viện phí trực tiếp</td>
                            <td style="text-align: center">Thu dịch vụ y tế dự phòng </td>
                            <td style="text-align: center">Thu KCB theo yêu cầu</td>
                            <td style="text-align: center">Các khoản thu sự nghiệp khác</td>
                        </tr>
                        <tr>
                            <td style="font-style: italic; text-align: center">1</td>
                            <td style="font-style: italic; text-align: center">2</td>
                            <td style="font-style: italic; text-align: center">3</td>
                            <td style="font-style: italic; text-align: center">4</td>
                            <td style="font-style: italic; text-align: center">5</td>
                            <td style="font-style: italic; text-align: center">6</td>
                            <td style="font-style: italic; text-align: center">7 =8+12+13+14</td>
                            <td style="font-style: italic; text-align: center">8 =9+10+11</td>
                            <td style="font-style: italic; text-align: center">9</td>
                            <td style="font-style: italic; text-align: center">10</td>
                            <td style="font-style: italic; text-align: center">11</td>
                            <td style="font-style: italic; text-align: center">12</td>
                            <td style="font-style: italic; text-align: center">13</td>
                            <td style="font-style: italic; text-align: center">14 =15+...+19</td>
                            <td style="font-style: italic; text-align: center">15</td>
                            <td style="font-style: italic; text-align: center">16</td>
                            <td style="font-style: italic; text-align: center">17</td>
                            <td style="font-style: italic; text-align: center">18</td>
                            <td style="font-style: italic; text-align: center">19</td>
                        </tr>
                    </tbody>
                </table>
                
                <table id="tableHeader2" class="mainTable" border="0" width="100%" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td align="center" colspan="16">
                                <strong style="font-size:16px">TÌNH HÌNH CHI NGÂN SÁCH Y TẾ</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <table id="mainTable2" width="100%" border="1" cellpadding="2" cellspacing="0">
                    <tbody>
                        <tr>
                            <td style="text-align: center" rowspan="3">TT</td>
                            <td style="text-align: center" rowspan="3">Tên cơ sở</td>
                            <td style="text-align: center" rowspan="3">TỔNG CHI</td>
                            <td style="text-align: center" colspan="2">Chi nghiệp vụ</td>
                            <td style="text-align: center" rowspan="3">Chi đầu tư XDCB</td>
                            <td style="text-align: center" rowspan="3">Chi trả nợ đọng</td>
                            <td style="text-align: center" rowspan="3">Chi khác</td>
                            <td style="text-align: center" rowspan="3">Số dư cuối kỳ</td>
                            <td style="text-align: center" rowspan="3">Trích lập Quỹ Khen thưởng, Phúc lợi</td>
                            <td style="text-align: center" rowspan="2" colspan="2">Trích lập Quỹ ổn định thu nhập (bao gồm chi thu nhập tăng thêm)</td>
                            <td style="text-align: center" rowspan="3">Trích lập Quỹ khác </td>
                            <td style="text-align: center" rowspan="3">Kinh phí cải cách tiền lương</td>
                        </tr>
                        <td style="text-align: center" rowspan="2">Tổng số</td>
                        <td style="text-align: center" colspan="2">Trong đó</td>
                        <tr>
                            <td style="text-align: center">Chi thuốc của Nhà thuốc Bệnh viện</td>
                            <td style="text-align: center">Chi thuốc, vật tư, hóa chất, máu.. phục vụ KC,CB</td>
                            <td style="text-align: center" rowspan="1">Tổng số</td>
                            <td style="text-align: center" rowspan="1">Tỷ lệ so với Tiền lương ngạch bậc (hệ số thu nhập tăng thêm)</td>
                        </tr>
                        <tr>
                            <td style="text-align: center;font-style: italic">1</td>
                            <td style="text-align: center;font-style: italic">2</td>
                            <td style="text-align: center;font-style: italic">20 =21+22+25+26</td>
                            <td style="text-align: center;font-style: italic">21</td>
                            <td style="text-align: center;font-style: italic">22</td>
                            <td style="text-align: center;font-style: italic">23</td>
                            <td style="text-align: center;font-style: italic">24</td>
                            <td style="text-align: center;font-style: italic">25</td>
                            <td style="text-align: center;font-style: italic">26</td>
                            <td style="text-align: center;font-style: italic">27</td>
                            <td style="text-align: center;font-style: italic">28</td>
                            <td style="text-align: center;font-style: italic">29 =7-20-27-28</td>
                            <td style="text-align: center;font-style: italic">30</td>
                            <td style="text-align: center;font-style: italic">31</td>
                            <td style="text-align: center;font-style: italic">32</td>
                            <td style="text-align: center;font-style: italic">33</td>
                            <td style="text-align: center;font-style: italic">34</td>
                            <td style="text-align: center;font-style: italic">35</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Constants and Configuration
        const LEVEL_ORG_SELECT_TYPE = {
            TW: { type: 'bctw', tableID: 'bch', err: 'Biểu này không áp dụng cho cấp trung ương' },
            TINH: { type: 'bct', tableID: 'bch' },
            HUYEN: { type: 'bch', tableID: 'bch' },
            XA: { type: 'bcx', tableID: 'bcx', err: 'Biểu này không áp dụng cho cấp xã' },
            INDIVIDUAL_TINH: { type: 'INDIVIDUAL_TINH', tableID: 'bch' },
            INDIVIDUAL_HUYEN: { type: 'INDIVIDUAL_HUYEN', tableID: 'bch' },
            HUYEN_TTTYT: { type: 'HUYEN_TTYT', tableID: 'bch' }
        };

        // Mock Data
        const mockData = {
            orgSelected: {
                id: "mockOrgId123",
                name: "Mock Organization"
            },
            periods: "202301;202302;202303",
            orgHirch: LEVEL_ORG_SELECT_TYPE.TINH,
            load: 0,
            sumAll: ["mockSumAll1", "mockSumAll2"],
            sumA: ["mockSumA1", "mockSumA2"],
            sumI: ["mockSumI1", "mockSumI2"],
            sumII: ["mockSumII1", "mockSumII2"],
            sumIII: ["mockSumIII1", "mockSumIII2"],
            sumI_1_1: ["mockSumI_1_1"],
            sumI_1_2: ["mockSumI_1_2"],
            sumI_1_3: ["mockSumI_1_3"],
            seri: 0,
            stt: 0,
            arrColumn: [],
            arrGroupByPhanLoai: [],
            listBtn: [],
            btn: null,
            orgUnitSelectedGroupID: [],
            numberColumnCatch: 17
        };

        // Mock Functions
        const mockFunctions = {
            get: (url, callback) => {
                console.log(`Mock GET request to: ${url}`);
                setTimeout(() => {
                    // Mock response for organization unit check
                    if (url.includes('organisationUnits')) {
                        callback({
                            id: mockData.orgSelected.id,
                            level: 3,
                            organisationUnitGroups: [
                                { id: "mH8ggZyC39Z" } // Mock Tinh group
                            ]
                        });
                    } 
                    // Mock response for analytics data
                    else if (url.includes('analytics.json')) {
                        const mockAnalyticsData = {
                            headers: [
                                { name: "dx", column: "Data" },
                                { name: "ou", column: "Organisation unit" },
                                { name: "pe", column: "Period" },
                                { name: "value", column: "Value" }
                            ],
                            rows: generateMockDataRows()
                        };
                        callback(mockAnalyticsData);
                    }
                }, 100);
            },
            
            p2ild: {
                dvu: {
                    getValueSum: (json, elements, orgId, dataType) => {
                        const value = Math.floor(Math.random() * 1000000);
                        return dataType === 'MONEY' ? value.toLocaleString() : value.toString();
                    },
                    getValueDE: (json, elements, orgId, dataType, options, hideZero) => {
                        const value = Math.floor(Math.random() * 500000);
                        return dataType === 'MONEY' ? value.toLocaleString() : value.toString();
                    },
                    dataTypesSupport: {
                        MONEY: "MONEY"
                    }
                },
                ou: {
                    stringGroups: (groups, orgId) => {
                        return groups.concat([orgId]).join(";");
                    },
                    remapResultByAncestor: (json, level) => {
                        return Promise.resolve(json);
                    }
                },
                ExportDataUtils: {
                    cloneTableDataWithoutLib: {
                        apply: () => console.log("Mock export data utils applied")
                    }
                },
                DesignUtil: {
                    hidePreload: () => console.log("Mock preload hidden")
                },
                ApproveUtil: {
                    initForceAcceptAll: {
                        call: (context, options) => console.log("Mock approve util initialized", options)
                    }
                }
            },
            
            ApproveButtonBuilder: {
                BUTTON_TYPE: {
                    TYPE_APPROVE: "TYPE_APPROVE",
                    TYPE_ACCEPT: "TYPE_ACCEPT"
                },
                initButton: function(type, orgId, elements, periods) {
                    this.type = type;
                    this.orgId = orgId;
                    this.elements = elements;
                    this.periods = periods;
                    return this;
                },
                toStringHTML: function() {
                    return `<button class="mock-btn">${this.type}</button>`;
                },
                createButtonWithPosition: function(selector) {
                    console.log(`Creating button at ${selector}`);
                },
                setStateButton: function() {
                    console.log("Setting button state");
                },
                addOnClickBtn: function() {
                    console.log("Adding button click handler");
                }
            }
        };

        // Generate mock data rows for analytics
        function generateMockDataRows() {
            const rows = [];
            const dataElements = [
                'uMmm9GZneMR.AMARAl67O0W', 'uMmm9GZneMR.je3ZoC0J1J2', 'uMmm9GZneMR.W3J7OtuzmSr',
                'JPyFARPu7zV', 'dbThC9ZIqvB', 'Ff7B08GIU5z', 'HcKlezEKswk', 'n2yWJTs36lZ',
                'YwZDwgKpNoD', 'AXPRYRVmtKV', 'hDGQf04ot5x', 'itAHBgwcw7w', 'wNLX1JVg5aB'
            ];
            
            dataElements.forEach(de => {
                rows.push([de, mockData.orgSelected.id, mockData.periods.split(';')[0], Math.floor(Math.random() * 1000000)]);
            });
            
            return rows;
        }

        // Global Variables
        let orgHirch = mockData.orgHirch;
        let load = mockData.load;
        let seri = mockData.seri;
        let stt = mockData.stt;
        let listBtn = mockData.listBtn;
        let btn = mockData.btn;
        let orgUnitSelectedGroupID = mockData.orgUnitSelectedGroupID;
        let orgUnitSelectedID = mockData.orgSelected.id;
        
        // UI State
        let isLoading = false;
        let loadStatus = '';

        // jQuery-like helper
        function $(selector) {
            return {
                append: (html) => {
                    console.log(`Appending HTML to ${selector}`);
                    const element = document.querySelector(selector);
                    if (element) {
                        element.innerHTML += html;
                        console.log(`Successfully appended to ${selector}`);
                    } else {
                        console.warn(`Element not found: ${selector}`);
                    }
                }
            };
        }

        // Update UI state
        function updateLoadingState(loading, status) {
            isLoading = loading;
            loadStatus = status;
            
            const btn = document.getElementById('loadDataBtn');
            const statusEl = document.getElementById('loadStatus');
            
            btn.disabled = loading;
            btn.textContent = loading ? 'Loading...' : 'Load Data';
            btn.style.backgroundColor = loading ? '#6c757d' : '#007bff';
            btn.style.cursor = loading ? 'not-allowed' : 'pointer';
            
            statusEl.textContent = status;
        }

        // Check Selected Organisation Unit
        function checkSelectedOrganisationUnit() {
            return new Promise((resolve, reject) => {
                mockFunctions.get("../api/organisationUnits/" + orgUnitSelectedID + ".json?fields=id,organisationUnitGroups[id],level", function (json) {
                    orgUnitSelectedGroupID = json.organisationUnitGroups;
                    if (orgUnitSelectedID == "LOdti1gATwC") { //TW
                        orgHirch = LEVEL_ORG_SELECT_TYPE.TW;
                    } else if (json.organisationUnitGroups.some(x => x.id == "mH8ggZyC39Z")) { //Tinh
                        orgHirch = LEVEL_ORG_SELECT_TYPE.TINH;
                    } else if (json.organisationUnitGroups.some(x => x.id == "W4U1KdFeIJH")) { //Huyen
                        orgHirch = LEVEL_ORG_SELECT_TYPE.HUYEN;
                    } else if (json.organisationUnitGroups.some(x => x.id == "OHWM3DxkeMR")) { //Xa
                        orgHirch = LEVEL_ORG_SELECT_TYPE.XA;
                    } else {
                        if (json.level == 3) {
                            orgHirch = LEVEL_ORG_SELECT_TYPE.INDIVIDUAL_TINH;
                        } else if (json.level == 4) {
                            if (json.organisationUnitGroups.some(x => ["JchZd7bGhgr"].includes(x.id))) {
                                orgHirch = LEVEL_ORG_SELECT_TYPE.HUYEN_TTTYT;
                            } else {
                                orgHirch = LEVEL_ORG_SELECT_TYPE.INDIVIDUAL_HUYEN;
                            }
                        }
                    }
                    resolve(orgHirch);
                });
            });
        }

        // Sum function to load and display data
        function sum(idGroups, seri, title, isGroup) {
            let htmlReport1 = "";
            let htmlReport2 = "";
            stt = 0;
            let strButton = "";

            // Build button for specific groups
            if (idGroups === mockData.sumI) {
                btn = Object.assign({}, mockFunctions.ApproveButtonBuilder);
                btn.initButton(btn.BUTTON_TYPE.TYPE_APPROVE, orgUnitSelectedID, ["UzwCwXGMIQq"], mockData.periods);
                strButton = btn.toStringHTML();
                listBtn.push(btn);
            } else {
                strButton = "";
            }

            // Build HTML rows
            htmlReport1 += "<tr class='data-row'><td align='center'><strong>" + seri + strButton + "</strong></td>";
            htmlReport2 += "<tr class='data-row'><td align='center'><strong>" + seri + "</strong></td>";
            
            if (title == "TỔNG SỐ") {
                htmlReport1 += "<td align='center'><strong>" + title + "</strong></td>";
                htmlReport2 += "<td align='center'><strong>" + title + "</strong></td>";
            } else {
                htmlReport1 += "<td align='left'><strong>" + title + "</strong></td>";
                htmlReport2 += "<td align='left'><strong>" + title + "</strong></td>";
            }

            const des = "uMmm9GZneMR.AMARAl67O0W;uMmm9GZneMR.je3ZoC0J1J2;uMmm9GZneMR.W3J7OtuzmSr;uMmm9GZneMR.Ky9vKtpkbsi;rjWwV8cqhAZ;JPyFARPu7zV;LL7qpUiC3hZ;OQBOipGcNOK;dbThC9ZIqvB;DXgyPsmNqyK;Ff7B08GIU5z;HcKlezEKswk;n2yWJTs36lZ;YwZDwgKpNoD;AXPRYRVmtKV;rO33E6B0ZWO;yfdj9NBMWHW;hDGQf04ot5x;itAHBgwcw7w;wNLX1JVg5aB;gSMOBV405ZL;a99Sg2Rye5x";

            return new Promise((resolve, reject) => {
                mockFunctions.get("../api/analytics.json?dimension=dx:" + des + "&dimension=ou:" + mockFunctions.p2ild.ou.stringGroups(idGroups, orgUnitSelectedID) + "&filter=pe:" + mockData.periods + "&skipRounding=true", function (json) {
                    // Table 1 data
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["uMmm9GZneMR.AMARAl67O0W"], undefined) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["uMmm9GZneMR.je3ZoC0J1J2"], undefined) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["uMmm9GZneMR.W3J7OtuzmSr"], undefined) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["uMmm9GZneMR.Ky9vKtpkbsi"], undefined) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["JPyFARPu7zV"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["dbThC9ZIqvB"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["Ff7B08GIU5z"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["HcKlezEKswk"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["n2yWJTs36lZ"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["YwZDwgKpNoD"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["AXPRYRVmtKV"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["yfdj9NBMWHW"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["hDGQf04ot5x"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["itAHBgwcw7w"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["wNLX1JVg5aB"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["gSMOBV405ZL"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["a99Sg2Rye5x"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport1 += "</tr>";

                    // Table 2 data
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["oYEG52Q9lF9"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["heFbKPFOAYX"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["VUujYXiLcQo"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["RrIm3S7jizc"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["teZ9uzWsdC8"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["IAEwNuqpwJ6"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["RyVb0zCOSm5"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["glJjiwPA4nz"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["i4GretwfRCc"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["ak98gs8nPyq"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["LbJkh0Bhfdj"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["JHh30oApLHO"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["q8Vt5iqopMh"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["gzQmDaPEAOt"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["bX0BZBY87ey"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "<td align='center'><strong>" + mockFunctions.p2ild.dvu.getValueSum(json, ["eT2Ghp7Dhhj"], undefined, mockFunctions.p2ild.dvu.dataTypesSupport.MONEY) + "</strong></td>";
                    htmlReport2 += "</tr>";

                    // Append to tables
                    $("#formreport #mainTable1").append(htmlReport1);
                    $("#formreport #mainTable2").append(htmlReport2);

                    resolve();
                });
            });
        }

        // Load Report function
        function loadReport() {
            load++;
            switch (orgHirch) {
                case LEVEL_ORG_SELECT_TYPE.TINH:
                    if (load == 1) {
                        sum(mockData.sumAll, "", "TỔNG SỐ", true)
                            .then(() => {
                                loadReport();
                            })
                            .catch((e) => {
                                loadReport();
                            });
                    }
                    if (load == 2) {
                        sum(mockData.sumA, "A", "Y tế công", true)
                            .then(() => {
                                loadReport();
                            })
                            .catch((e) => {
                                loadReport();
                            });
                    }
                    if (load == 3) {
                        sum(mockData.sumI, "I", "Tuyến tỉnh", true)
                            .then(() => {
                                loadReport();
                            })
                            .catch((e) => {
                                loadReport();
                            });
                    }
                    if (load == 4) {
                        sum(mockData.sumII, "II", "Cấp huyện", true)
                            .then(() => {
                                loadReport();
                            })
                            .catch((e) => {
                                loadReport();
                            });
                    }
                    if (load == 5) {
                        sum(mockData.sumIII, "III", "Cấp xã", true)
                            .then(() => {
                                lastLoad();
                            })
                            .catch((e) => {
                                lastLoad();
                            });
                    }
                    break;
                    
                case LEVEL_ORG_SELECT_TYPE.HUYEN:
                    if (load == 1) {
                        sum(mockData.sumAll, "", "TỔNG SỐ", true)
                            .then(() => { loadReport(); })
                            .catch((e) => { loadReport(); });
                    }
                    if (load == 2) {
                        sum(mockData.sumI, "I", "Cấp huyện", true)
                            .then(() => { loadReport(); })
                            .catch((e) => { loadReport(); });
                    }
                    if (load == 3) {
                        sum(mockData.sumII, "II", "Cấp xã", true)
                            .then(() => { lastLoad(); })
                            .catch((e) => { lastLoad(); });
                    }
                    break;
                    
                default:
                    if (load == 1) {
                        sum(mockData.sumAll, "", "TỔNG SỐ", true)
                            .then(() => { lastLoad(); })
                            .catch((e) => { lastLoad(); });
                    }
                    break;
            }
        }

        // Last Load function
        function lastLoad() {
            mockFunctions.p2ild.ExportDataUtils.cloneTableDataWithoutLib.apply(mockFunctions.p2ild.ExportDataUtils);
            load = 0;
            mockFunctions.p2ild.DesignUtil.hidePreload();
            
            if (listBtn.length != 0) {
                listBtn.forEach(e => {
                    e.setStateButton();
                    e.addOnClickBtn();
                });
            }
            
            mockFunctions.p2ild.ApproveUtil.initForceAcceptAll.call(this, {
                anchor: '.custom-btn',
                listBtn: listBtn || []
            });
            
            // Update loading state
            updateLoadingState(false, 'Data loading completed!');
            
            // Clear status after a few seconds
            setTimeout(() => {
                updateLoadingState(false, '');
            }, 3000);
        }

        // Main loadData function
        function loadData() {
            console.log("Starting loadData function...");
            updateLoadingState(true, 'Initializing data load...');
            
            // Reset load counter
            load = 0;
            
            // Clear any existing data in tables
            const mainTable1 = document.getElementById('mainTable1');
            const mainTable2 = document.getElementById('mainTable2');
            
            if (mainTable1) {
                const tbody = mainTable1.querySelector('tbody');
                const headerRows = tbody.querySelectorAll('tr');
                // Keep first 4 rows (headers), remove the rest
                for (let i = headerRows.length - 1; i >= 4; i--) {
                    headerRows[i].remove();
                }
            }
            
            if (mainTable2) {
                const tbody = mainTable2.querySelector('tbody');
                const headerRows = tbody.querySelectorAll('tr');
                // Keep first 4 rows (headers), remove the rest
                for (let i = headerRows.length - 1; i >= 4; i--) {
                    headerRows[i].remove();
                }
            }
            
            updateLoadingState(true, 'Checking organization unit...');
            
            // Check organization unit and start loading report
            checkSelectedOrganisationUnit()
                .then((orgType) => {
                    console.log("Organization type determined:", orgType);
                    updateLoadingState(true, `Organization type: ${orgType.type || 'Unknown'}`);
                    orgHirch = orgType;
                    
                    // Start the loading process
                    setTimeout(() => {
                        console.log("Starting loadReport process...");
                        updateLoadingState(true, 'Loading report data...');
                        loadReport();
                    }, 500);
                })
                .catch((error) => {
                    console.error("Error checking organization unit:", error);
                    updateLoadingState(true, 'Error checking org unit, using fallback...');
                    // Fallback to default loading
                    setTimeout(() => {
                        console.log("Fallback: Starting loadReport process...");
                        updateLoadingState(true, 'Loading report data (fallback)...');
                        loadReport();
                    }, 500);
                });
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const loadBtn = document.getElementById('loadDataBtn');
            loadBtn.addEventListener('click', loadData);
            
            console.log('B2 Report initialized. Click "Load Data" to start.');
        });
    </script>
</body>
</html> 